#!/bin/sh
# -*- Mode: sh; indent-tabs-mode: nil; tab-width: 2; coding: utf-8 -*-
#
# This file is part of Déjà Dup.
# © 2008,2009 Michael Terry <mike@mterry.name>
#
# Déjà Dup is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# Déjà Dup is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Déjà Dup.  If not, see <http://www.gnu.org/licenses/>.

set -e

SCRIPTDIR='.'
SCRIPTDIR=$(readlink -m "$SCRIPTDIR")
SRCDIR="$SCRIPTDIR/duplicity-src"
INSTDIR="$SCRIPTDIR/duplicity"

download_tgz()
{
  mkdir -p "$SRCDIR"
  if [ ! -e "$SRCDIR/$1" ]; then
    wget "http://download.savannah.gnu.org/releases-noredirect/duplicity/$1" -P "$SRCDIR"
  fi
}

install_tgz()
{
  mkdir -p "$INSTDIR"
  
  TGZ="$SRCDIR/duplicity-$1.tar.gz"
  
  if [ "$1" != "bzr" ] && [ -d "$INSTDIR/duplicity-$1" ]; then
    return
  fi
  
  download_tgz $(basename "$TGZ")
  
  BUILDDIR=$(mktemp -d)
  tar -xzf "$TGZ" -C "$BUILDDIR"
  
  cd "$BUILDDIR"/*
  ./setup.py install --root="$INSTDIR/duplicity-$1" --prefix="/usr/local" > /dev/null
  cd -
  
  rm -r "$BUILDDIR"
}

install_bzr()
{
  mkdir -p "$SRCDIR"
  if [ -d "$SRCDIR/duplicity-bzr" ]; then
    cd "$SRCDIR/duplicity-bzr"
    if LANG=C bzr update | grep "Tree is up to date"; then
      #install_tgz "bzr"
      #return
      : # ignore...  Still want to makedist.  Doesn't cost much to redo, and
        # lets us package changes made in the tree since last update
    fi
  else
    # Don't use lp:duplicity because that likes to use bzr+ssh, which can prompt
    # for ssh passphrase (which we don't want)
    bzr co "http://bazaar.launchpad.net/~vcs-imports/duplicity/trunk" "$SRCDIR/duplicity-bzr"
    cd "$SRCDIR/duplicity-bzr"
  fi
  ./dist/makedist "999" # fake a really big version number
  mv "duplicity-999.tar.gz" "../duplicity-bzr.tar.gz"
  install_tgz "bzr"
}

if [ -z "$1" ]; then
  echo 'Must provide a duplicity version'
  exit 1
elif [ "$1" = "bzr" ]; then
  install_bzr
  exit 0
else
  install_tgz "$1"
  exit 0
fi

